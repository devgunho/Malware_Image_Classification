import hashlib
import math
import os
import sys

import file_open_easygui as fopen

from Crypto.Cipher import AES
from PIL import Image
from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5 import uic

# import .ui file
# .ui file must be located in the same directory as the Python code file.
form_class = uic.loadUiType("MainWindow.ui")[0]


def getBinaryData(filePath):
    binaryValues = []
    file = open(filePath, "rb")
    data = file.read(1)
    while data != b"":
        try:
            binaryValues.append(ord(data))
        except TypeError:
            pass
        data = file.read(1)
    return binaryValues


def makeEncFile(filePath, fileName):
    encryptor = AES.new('This is a key123'.encode("utf8"), AES.MODE_CBC, 'This is an IV456'.encode("utf8"))

    if((os.path.isdir('./Encryption')) == False):
        os.mkdir('./Encryption')
    out_filepath = './Encryption/' + fileName + '.enc'
    with open(filePath, "rb") as readFile:
        with open(out_filepath, "wb") as writefile:
            chunkSize = 65536
            while True:
                chunk = readFile.read(chunkSize)
                if len(chunk) == 0:
                    break
                elif len(chunk) % 16 != 0:
                    chunk += b' ' * (16 - len(chunk) % 16)
                writefile.write(encryptor.encrypt(chunk))


class WindowClass(QtWidgets.QMainWindow, form_class):   # GUI Class Define
    def __init__(self):
        super().__init__()
        self.setupUi(self)

        self.fileOpen_Btn.clicked.connect(self.fileOpen_Btn_function)
        self.encryption_Btn.clicked.connect(self.encryption_Btn_function)
        self.imgConv_Btn.clicked.connect(self.imgConv_Btn_function)
        self.multi_Btn.clicked.connect(self.multi_Btn_function)
        self.smallerSizeMulti_Btn.clicked.connect(self.smallerSizeMulti_Btn_function)

    def fileOpen_Btn_function(self):
        print("[*] fileOpen_Btn_function")
        dirPath = fopen.OpenWinFileExplorer()
        print(" directory path: ", dirPath)
        self.filePath.setText(dirPath)

    def imgConv_Btn_function(self):
        print("[*] Image Conversion")
        fileCnt = 0
        saveFileCnt = 0
        for(path, dir, files) in os.walk(self.filePath.text()):
            for filename in files:
                ext = os.path.splitext(filename)[-1]
                fileCnt += 1
                print("[%d] %s\%s" % (fileCnt, path, filename))
                fileSize = os.path.getsize(path+'/'+filename)

                # 1MB(1024KB) ~ 200MB
                if((fileSize >= 1048576) & (fileSize <= 1048576*200)):
                    saveFileCnt += 1
                    binaryData = getBinaryData(path+'/'+filename)
                    print("  size: ", fileSize, "/ sqrt: ",
                          (int)(math.sqrt(fileSize)))
                    grayScaleImg = Image.new(
                        'L', ((int)(math.sqrt(fileSize))+1, (int)(math.sqrt(fileSize))+1))
                    grayScaleImg.putdata(binaryData)
                    # grayScaleImgName = filename + ".png"
                    grayScaleImgName = "Normal" + \
                        str(saveFileCnt) + "-" + str(fileSize) + ext + ".png"
                    grayScaleImg.save(grayScaleImgName)
        print("[*] Image Conversion END")

    def encryption_Btn_function(self):
        print("[*] Encryption")
        fileCnt = 0
        saveFileCnt = 0
        try:
            for(path, dir, files) in os.walk(self.filePath.text()):
                for filename in files:
                    ext = os.path.splitext(filename)[-1]
                    fileCnt += 1
                    print("[%d] %s\%s" % (fileCnt, path, filename))
                    fileSize = os.path.getsize(path+'/'+filename)

                    # 1MB(1024KB) ~ 200MB
                    if((fileSize >= 1048576) & (fileSize <= 1048576*200)):
                        saveFileCnt += 1
                        makeEncFile(path + '/' + filename, filename)
                        binaryEncData = getBinaryData(
                            './Encryption/' + filename + '.encrypted')
                        print("  size: ", fileSize, "/ sqrt: ",
                            (int)(math.sqrt(fileSize)))
                        grayScaleImg = Image.new(
                            'L', ((int)(math.sqrt(fileSize))+1, (int)(math.sqrt(fileSize))+1))
                        grayScaleImg.putdata(binaryEncData)
                        # grayScaleImgName = filename + ".png"
                        grayScaleImgName = "Encryption" + \
                            str(saveFileCnt) + "-" + str(fileSize) + ext + ".png"
                        grayScaleImg.save(grayScaleImgName)
        except (RuntimeError, TypeError, NameError):
            print("ERROR!")
            pass
        print("[*] Encryption END")

    def multi_Btn_function(self):
        print("[*] Create Two Types of Images Simultaneously")
        fileCnt = 0
        saveFileCnt = 0
        try:
            for(path, dir, files) in os.walk(self.filePath.text()):
                for filename in files:
                    ext = os.path.splitext(filename)[-1]
                    fileCnt += 1
                    print("[%d] %s\%s" % (fileCnt, path, filename))
                    fileSize = os.path.getsize(path+'/'+filename)

                    # 1MB(1024KB) ~ 200MB
                    if((fileSize >= 1048576) & (fileSize <= 1048576*200)):
                        saveFileCnt += 1
                        binaryData = getBinaryData(path+'/'+filename)
                        print(" original file size: ", fileSize, "/ sqrt: ",
                            (int)(math.sqrt(fileSize)))
                        grayScaleImg = Image.new(
                            'L', ((int)(math.sqrt(fileSize))+1, (int)(math.sqrt(fileSize))+1))
                        grayScaleImg.putdata(binaryData)
                        # grayScaleImgName = filename + ".png"
                        grayScaleImgName = "Normal" + \
                            str(saveFileCnt) + "-" + str(fileSize) + ext + ".png"
                        grayScaleImg.save(grayScaleImgName)

                        makeEncFile(path + '/' + filename, filename)
                        binaryEncData = getBinaryData(
                            './Encryption/' + filename + '.enc')
                        print(" encrypted file size: ", fileSize, "/ sqrt: ",
                            (int)(math.sqrt(fileSize)))
                        encGrayScaleImg = Image.new(
                            'L', ((int)(math.sqrt(fileSize))+1, (int)(math.sqrt(fileSize))+1))
                        encGrayScaleImg.putdata(binaryEncData)
                        # grayScaleImgName = filename + ".png"
                        encGrayScaleImgName = "Encryption" + \
                            str(saveFileCnt) + "-" + str(fileSize) + ext + ".png"
                        encGrayScaleImg.save(encGrayScaleImgName)
        except (RuntimeError, TypeError, NameError):
            print("ERROR!")
            pass
        print("[*] Create Two Types of Images Simultaneously END")

    def smallerSizeMulti_Btn_function(self):
        print("[*] Smaller Size Multi Btn")
        print("[*] Smaller Size Multi Btn END")

# QApplication : Run App
app = QtWidgets.QApplication(sys.argv)

# Create an instance of WindowClass
myWindow = WindowClass()

# Showing the program screen
myWindow.show()

# Code for entering a program into an event loop (which activates the program)
app.exec_()
